<!DOCTYPE html>
<html lang="en" ng-app>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <title>Olympia Administration</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Quicksand|Varela+Round">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.2.7/css/select.dataTables.min.css">
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/select/1.2.7/js/dataTables.select.min.js"></script>
    
    <script type="text/javascript">
    	/*global $*/
        function guid() {
			function s4() {
			return Math.floor((1 + Math.random()) * 0x10000)
				.toString(16)
				.substring(1);
			}
			return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
		}

        function handleLoginAttempt() {
            var username = $('#username').val();
            var password = $('#password').val();
            
            if (username.length > 0 && password.length > 0) {
		        Promise.resolve()
		        .then(function(){
					//the 'return' is required. Otherwise, the subsequent then will not wait for this to complete
		            return $.post('admin-login', 'username=' + username + '&password=' + password);
		        })
		        .then(function(auth){
		            if (auth.isValid){
		                $('#error').html(auth.message);
		                loadPage();
		                return;
		            } else {
		                $('#error').html(auth.message);
		                $('#username').html('bad');
		                $('#password').html('bad');
		            }
		        })
		        .catch(function(err){
		            console.log(err);
		        });
		    } else {
		        $('#error').html('Please provide both username and password');
		    }
        }

		function loadPage() {
            $("#adminsList").load("adminsList.html", function() {
				createAdminsTable();
            });
            $("#keysList").load("keysList.html", function() {
				createKeysTable();
            });
            $("#usersList").load("usersList.html", function() {
				createUsersTable();
            });
		}
		
		function createAdminsTable() {
            Promise.resolve()
            .then(function(){
                return $.post('admin-get-admins');
            })
            .then(function(admins){
                $('#admins').html('');
                $('#admins').append(
	                '<tr>' +
	                '<td><b>Username</b></td><td><b>First name</b></td><td><b>Last name</b></td>' +
	                '</tr>');
                admins.forEach(function(entity){
                    $('#admins').append(
                        '<tbody>' +
                        '<tr>' +
                        '<td data-userId="' + entity._id + '"><a href="javascript:modifyAdmin(\'' + entity.firstname + '\', \'' + entity.lastname + '\', \'' + entity.username + '\', \'' + entity.password + '\')">' + entity.username + '</a></td>' +
                        '<td>' + entity.firstname + '</td>' +
                        '<td>' + entity.lastname + '</td>' +
                        '</tr>' +
                        '</tbody>'
                    );
                });
            })
            .then(function(){
	            $('#admins').DataTable({
		            select: {
			            style:    'os',
			            selector: 'td:first-child'
		            },
		            order: [[ 1, 'asc' ]]
	            });
            })
            .catch(function(err){
                console.log(err);
            });
		}
		
		function createKeysTable() {
            Promise.resolve()
            .then(function(){
                return $.post('admin-get-keys');
            })
            .then(function(keys){
                $('#keys').html('');
                $('#keys').append(
	                '<tr>' +
	                '<td><b>Key name</b></td><td><b>UUID</b></td><td><b>Expires on</b></td>' +
	                '</tr>');
                keys.forEach(function(entity){
                    $('#keys').append(
                        '<tbody>' +
                        '<tr>' +
                        '<td data-userId="' + entity._id + '"><a href="javascript:modifyKey(\'' + entity.name + '\', \'' + entity.uuid + '\', \'' + entity.expiresDate + '\')">' + entity.name + '</a></td>' +
                        '<td>' + entity.uuid + '</td>' +
                        '<td>' + entity.expiresDate + '</td>' +
                        '</tr>' +
                        '</tbody>'
                    );
                });
            })
            .then(function(){
	            $('#keys').DataTable({
					columnDefs: [ {
						orderable: false,
			            className: 'select-checkbox',
			            targets:   0
		            } ],
		            select: {
			            style:    'os',
			            selector: 'td:first-child'
		            },
		            order: [[ 1, 'asc' ]]
	            });
            })
            .catch(function(err){
                console.log(err);
            });
		}
		
    	function createUsersTable() {
            //start a promise chain
            Promise.resolve()
            .then(function(){
                return $.post('admin-get-users');
            })
            .then(function(users){
                $('#users').html('');
				$('#users').append(
	                '<tr>' +
	                '<td class="checkbox-col"><input type="checkbox" style="text-align:center;" id="check_all" onclick=\'checkAll(this)\'</td>' +
                    '<td><b>Username</b></td>' +
                    '<td><b>First name</b></td>' +
                    '<td><b>Last name</b></td>' +
                    '<td><b>Key assigned</b></td>' +
	                '</tr>');
                users.forEach(function(entity){
                    $('#users').append(
                        '<tbody>' +
                        '<tr>' +
                        '<td class="checkbox-col"><input type="checkbox" style="text-align:center;" ng-model="x.dedbuffer"</td>' +
						'<td data-userId="' + entity._id + '">' + entity.username + '</a></td>' +
                        '<td>' + entity.firstName + '</td>' +
                        '<td>' + entity.lastName + '</td>' +
                        '<td>' + entity.key + '</td>' +
                        '</tr>' +
                        '</tbody>'
                    );
                });
            })
            .then(function(){
	            $('#users').DataTable({
					columnDefs: [ {
						orderable: false,
			            className: 'select-checkbox',
			            targets:   0
		            } ],
		            select: {
			            style:    'os',
			            selector: 'td:first-child'
		            },
		            order: [[ 1, 'asc' ]]
	            });
            })
            .catch(function(err){
                console.log(err);
            });
        }

        function addAdmin() {
			$("#admins-content").load("addAdmin.html");
        }
        function onAddAdmin() {
			var firstname = $('#new_admin_firstname').val();
            var lastname = $('#new_admin_lastname').val();
			var username = $('#new_admin_username').val();
            var password = $('#new_admin_password').val();

            Promise.resolve()
            .then(function(){
                return $.post('admin-add-admin', 'firstname=' + firstname + '&lastname=' + lastname + '&username=' + username + '&password=' + password);
            })
            .then(function(){
		        $("#adminsList").load("adminsList.html", function() {
					createAdminsTable();
		        });
            })
            .catch(function(err){
                console.log(err);
            });
        }
        function onAdminCancel() {
	        $("#adminsList").load("adminsList.html", function() {
				createAdminsTable();
	        });
        }

        function modifyAdmin(firstname, lastname, username, password) {
			$("#admins-content").load("modifyAdmin.html", function() {
				$('#new_admin_firstname').val(firstname);
				$('#new_admin_lastname').val(lastname);
				$('#new_admin_username').val(username);
				$('#new_admin_password').val(password);
			});
        }
        function onModifyAdmin() {
			var firstname = $('#new_admin_firstname').val();
            var lastname = $('#new_admin_lastname').val();
			var username = $('#new_admin_username').val();
            var password = $('#new_admin_password').val();

            Promise.resolve()
            .then(function(){
                return $.post('admin-modify-admin', 'firstname=' + firstname + '&lastname=' + lastname + '&username=' + username + '&password=' + password);
            })
            .then(function(){
		        $("#adminsList").load("adminsList.html", function() {
					createAdminsTable();
		        });
            })
            .catch(function(err){
                console.log(err);
            });
        }
        function onDeleteAdmin() {
			var username = $('#new_admin_username').val();

            Promise.resolve()
            .then(function(){
                return $.post('admin-delete-admin', 'username=' + username);
            })
            .then(function(){
		        $("#adminsList").load("adminsList.html", function() {
					createAdminsTable();
		        });
            })
            .catch(function(err){
                console.log(err);
            });
        }

		function addKey() {
			$("#keys-content").load("addKey.html");
        }
        function onAddKey() {
			var name = $('#new_key_name').val();
			var uuid = guid();
            var expiresDate = $('#new_key_expires_date').val();

            Promise.resolve()
            .then(function(){
                return $.post('admin-add-key', 'name=' + name + '&uuid=' + uuid + '&expiresDate=' + expiresDate);
            })
            .then(function(){
		        $("#keysList").load("keysList.html", function() {
					createKeysTable();
		        });
            })
            .catch(function(err){
                console.log(err);
            });
        }
        function onKeyCancel() {
	        $("#keysList").load("keysList.html", function() {
				createKeysTable();
	        });
        }

        function modifyKey(name, uuid, expiresDate) {
			$("#keys-content").load("modifyKey.html", function() {
				$('#new_key_name').val(name);
				$('#new_key_uuid').val(uuid);
				$('#new_key_expires_date').val(expiresDate);
			});
        }
        function onModifyKey() {
			var name = $('#new_key_name').val();
            var uuid = $('#new_key_uuid').val();
			var expiresDate = $('#new_key_expires_date').val();

            Promise.resolve()
            .then(function(){
                return $.post('admin-modify-key', 'name=' + name + '&uuid=' + uuid + '&expiresDate=' + expiresDate);
            })
            .then(function(){
		        $("#keysList").load("keysList.html", function() {
					createKeysTable();
		        });
            })
            .catch(function(err){
                console.log(err);
            });
        }

        function checkAll(bx) {
			var cbs = document.getElementsByTagName('input');
			for(var i = 0; i < cbs.length; i++) {
				if (cbs[i].type == 'checkbox') {
					cbs[i].checked = bx.checked;
				}
			}
		}

        function changeKey() {

        }
	</script>
</head>
  
<body>
    <section id="header-section">
		<div class="container">
			<div class="header">
				<h1 id="main-title">Olympia</h1>
			</div>
		</div>
    </section>

    <section id="body-section">
		<div class="container" id="adminsList">
			<center>
				<div style="padding-top: 100pt;">
					<label>Sign in</label>
					<div class="form-group">
						<input type="text" class="form-control" id="username" placeholder="Username">
					</div>
					<div class="form-group">
						<input type="password" class="form-control" id="password" placeholder="Password">
					</div>
					<div class="form-group">
						<button class="btn btn-primary" onclick='handleLoginAttempt()'>Login</button>
					</div>
					<p id="error"></p>
				</div>
			</center>
		</div>

		<div class="container" id="keysList"></div>

		<div class="container" id="usersList"></div>
    </section>
    
  </body>
</html>
